window.onload=function(){'use strict';var reportError=function(message){document.getElementById('audio_error_message').innerHTML=message};var isMicrophoneInUse=!1;var toolActive='';var freqTable,micStream,notesArray,audioContext,sourceAudioNode,gainAudioNode,analyserAudioNode;var baseFreq=440;var currentNoteIndex=57;var isAudioContextSupported=function(){window.AudioContext=window.AudioContext||window.webkitAudioContext;if(window.AudioContext){return!0}
else{return!1}};var isGetUserMediaSupported=function(){navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia;if((navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)||navigator.getUserMedia){return!0}
return!1};var findFundamentalFreq=function(buffer,sampleRate){var n=1024;var bestK=-1;var bestR=0;for(var k=8;k<=1000;k++){var sum=0;for(var i=0;i<n;i++){sum+=((buffer[i]-128)/128)*((buffer[i+k]-128)/128)}
var r=sum/(n+k);if(r>bestR){bestR=r;bestK=k}
if(r>0.9){break}}
if(bestR>0.0025){var fundamentalFreq=sampleRate/bestK;return fundamentalFreq}
else{return-1}};var findClosestNote=function(freq,notes){var low=-1;var high=notes.length;while(high-low>1){var pivot=Math.round((low+high)/2);if(notes[pivot].frequency<=freq){low=pivot}else{high=pivot}}
if(Math.abs(notes[high].frequency-freq)<=Math.abs(notes[low].frequency-freq)){return notes[high]}else{return notes[low]}};var findCentsOffPitch=function(freq,refFreq){var log2=0.6931471805599453;var multiplicativeFactor=freq/refFreq;var cents=Math.floor(1200*(Math.log(multiplicativeFactor)/log2));return cents};var streamReceived=function(stream){micStream=stream;sourceAudioNode=audioContext.createMediaStreamSource(micStream);gainAudioNode=audioContext.createGain();sourceAudioNode.connect(gainAudioNode);gainAudioNode.gain.setValueAtTime(10,audioContext.currentTime);analyserAudioNode=audioContext.createAnalyser();analyserAudioNode.fftSize=2048;gainAudioNode.connect(analyserAudioNode)};var turnOffMicrophone=function(){if(isMicrophoneInUse){if(toolActive==='fingering'){window.cancelAnimationFrame(frameId);correctNotePosition='';correctNote='';consecutiveCorrectNotes=0;redPeriod=0;greenPeriod=0;updateNoteBeingPlayedFingering('?');resetCanvas()}else if(toolActive==='tuner'){updateNoteBeingPlayedTuner('?');updateOffPitchTuner('?')}else if(toolActive==='steadybowing'){updateNoteLockedIn('?');updateTimesOffPitch('?');updateAvgDevLength('?','?');updateNoteDuration('?');updateNoteStatus('?')}
document.getElementById(toolActive+'_button').innerHTML='Begin!'}
if(sourceAudioNode&&sourceAudioNode.mediaStream&&sourceAudioNode.mediaStream.stop){sourceAudioNode.mediaStream.stop()}
sourceAudioNode=null;gainAudioNode=null;analyserAudioNode=null;isMicrophoneInUse=!1};var turnOnMicrophone=function(tool){turnOffMicrophone();if(isGetUserMediaSupported()){notesArray=freqTable[baseFreq.toString()];var getUserMedia=navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices):function(constraints){return new Promise(function(resolve,reject){navigator.getUserMedia(constraints,resolve,reject)})};if(tool==='fingering'){getUserMedia({audio:!0,video:!1}).then(streamReceivedFingering).catch(reportError);giveNewNote()}else if(tool==='steadybowing'){getUserMedia({audio:!0,video:!1}).then(streamReceivedSteadyBowing).catch(reportError)}else if(tool==='tuner'){getUserMedia({audio:!0,video:!1}).then(streamReceivedTuner).catch(reportError)}
isMicrophoneInUse=!0}else{reportError('It looks like this browser does not support getUserMedia. '+'Check <a href="http://caniuse.com/#feat=stream">http://caniuse.com/#feat=stream</a> for more info.')}}
var toggleTool=function(tool){var toolButton=tool+'_button';if(document.getElementById(toolButton).innerHTML==='Begin!'){turnOnMicrophone(tool);document.getElementById(toolButton).innerHTML='Stop!';toolActive=tool}else{turnOffMicrophone()}}
var frameId;var correctNotePosition='';var correctNote='';var consecutiveCorrectNotes=0;var redPeriod=0;var greenPeriod=0;var availableNotes=[];var notePosY={'G0':262,'G1':248,'G2':236,'G3':222,'G4':210,'D0':210,'D1':196.5,'D2':183.5,'D3':169,'D4':157,'A0':157,'A1':143,'A2':130.5,'A3':116,'A4':103.5,'E0':103.5,'E1':89.5,'E2':77,'E3':63,'E4':51,};var noteMapping={'c-major':{'G0':'G3','sG0':'G#3','fG1':'G#3','G1':'A3','sG1':'A#3','fG2':'A#3','G2':'B3','G3':'C4','sG3':'C#4','fG4':'C#4','G4':'D4','sG4':'D#4','fD0':'C#4','D0':'D4','sD0':'D#4','fD1':'D#4','D1':'E4','D2':'F4','sD2':'F#4','fD3':'F#4','D3':'G4','sD3':'G#4','fD4':'G#4','D4':'A4','sD4':'A#4','fA0':'G#4','A0':'A4','sA0':'A#4','fA1':'A#4','A1':'B4','A2':'C5','sA2':'C#5','fA3':'C#5','A3':'D5','sA3':'D#5','fA4':'D#5','A4':'E5','fE0':'D#5','E0':'E5','E1':'F5','sE1':'F#5','fE2':'F#5','E2':'G5','sE2':'G#5','fE3':'G#5','E3':'A5','sE3':'A#5','fE4':'A#5','E4':'B5',},'g-major':{'G0':'G3','sG0':'G#3','fG1':'G#3','G1':'A3','sG1':'A#3','fG2':'A#3','G2':'B3','G3':'C4','sG3':'C#4','fG4':'C#4','G4':'D4','sG4':'D#4','fD0':'C#4','D0':'D4','sD0':'D#4','fD1':'D#4','D1':'E4','nD2':'F4','D2':'F#4','D3':'G4','sD3':'G#4','fD4':'G#4','D4':'A4','sD4':'A#4','fA0':'G#4','A0':'A4','sA0':'A#4','fA1':'A#4','A1':'B4','A2':'C5','sA2':'C#5','fA3':'C#5','A3':'D5','sA3':'D#5','fA4':'D#5','A4':'E5','fE0':'D#5','E0':'E5','nE1':'F5','E1':'F#5','E2':'G5','sE2':'G#5','fE3':'G#5','E3':'A5','sE3':'A#5','fE4':'A#5','E4':'B5',},'d-major':{'G0':'G3','sG0':'G#3','fG1':'G#3','G1':'A3','sG1':'A#3','fG2':'A#3','G2':'B3','nG3':'C4','G3':'C#4','G4':'D4','sG4':'D#4','D0':'D4','sD0':'D#4','fD1':'D#4','D1':'E4','nD2':'F4','D2':'F#4','D3':'G4','sD3':'G#4','fD4':'G#4','D4':'A4','sD4':'A#4','fA0':'G#4','A0':'A4','sA0':'A#4','fA1':'A#4','A1':'B4','nA2':'C5','A2':'C#5','A3':'D5','sA3':'D#5','fA4':'D#5','A4':'E5','fE0':'D#5','E0':'E5','nE1':'F5','E1':'F#5','E2':'G5','sE2':'G#5','fE3':'G#5','E3':'A5','sE3':'A#5','fE4':'A#5','E4':'B5',},'a-major':{'nG0':'G3','G0':'G#3','G1':'A3','sG1':'A#3','fG2':'A#3','G2':'B3','nG3':'C4','G3':'C#4','G4':'D4','sG4':'D#4','D0':'D4','sD0':'D#4','fD1':'D#4','D1':'E4','nD2':'F4','D2':'F#4','nD3':'G4','D3':'G#4','D4':'A4','sD4':'A#4','A0':'A4','sA0':'A#4','fA1':'A#4','A1':'B4','nA2':'C5','A2':'C#5','A3':'D5','sA3':'D#5','fA4':'D#5','A4':'E5','fE0':'D#5','E0':'E5','nE1':'F5','E1':'F#5','nE2':'G5','E2':'G#5','E3':'A5','sE3':'A#5','fE4':'A#5','E4':'B5',},'e-major':{'nG0':'G3','G0':'G#3','G1':'A3','sG1':'A#3','fG2':'A#3','G2':'B3','nG3':'C4','G3':'C#4','nG4':'D4','G4':'D#4','nD0':'D4','D0':'D#4','D1':'E4','nD2':'F4','D2':'F#4','nD3':'G4','D3':'G#4','D4':'A4','sD4':'A#4','A0':'A4','sA0':'A#4','fA1':'A#4','A1':'B4','nA2':'C5','A2':'C#5','nA3':'D5','A3':'D#5','A4':'E5','E0':'E5','nE1':'F5','E1':'F#5','nE2':'G5','E2':'G#5','E3':'A5','sE3':'A#5','fE4':'A#5','E4':'B5',},'b-major':{'nG0':'G3','G0':'G#3','nG1':'A3','G1':'A#3','G2':'B3','nG3':'C4','G3':'C#4','nG4':'D4','G4':'D#4','nD0':'D4','D0':'D#4','D1':'E4','nD2':'F4','D2':'F#4','nD3':'G4','D3':'G#4','nD4':'A4','D4':'A#4','nA0':'A4','A0':'A#4','A1':'B4','nA2':'C5','A2':'C#5','nA3':'D5','A3':'D#5','A4':'E5','E0':'E5','nE1':'F5','E1':'F#5','nE2':'G5','E2':'G#5','nE3':'A5','E3':'A#5','E4':'B5',},'f-sharp-major':{'nG0':'G3','G0':'G#3','nG1':'A3','G1':'A#3','G2':'B3','nG3':'C4','G3':'C#4','nG4':'D4','G4':'D#4','nD0':'D4','D0':'D#4','nD1':'E4','D1':'F4','D2':'F#4','nD3':'G4','D3':'G#4','nD4':'A4','D4':'A#4','nA0':'A4','A0':'A#4','A1':'B4','nA2':'C5','A2':'C#5','nA3':'D5','A3':'D#5','nA4':'E5','A4':'F5','nE0':'E5','E0':'F5','E1':'F#5','nE2':'G5','E2':'G#5','nE3':'A5','E3':'A#5','E4':'B5',},'c-sharp-major':{'nG0':'G3','G0':'G#3','nG1':'A3','G1':'A#3','nG2':'B3','G2':'C4','G3':'C#4','nG4':'D4','G4':'D#4','nD0':'D4','D0':'D#4','nD1':'E4','D1':'F4','D2':'F#4','nD3':'G4','D3':'G#4','nD4':'A4','D4':'A#4','nA0':'A4','A0':'A#4','nA1':'B4','A1':'C5','A2':'C#5','nA3':'D5','A3':'D#5','nA4':'E5','A4':'F5','nE0':'E5','E0':'F5','E1':'F#5','nE2':'G5','E2':'G#5','nE3':'A5','E3':'A#5','nE4':'B5','E4':'C6',},'f-major':{'G0':'G3','sG0':'G#3','fG1':'G#3','G1':'A3','G2':'A#3','nG2':'B3','G3':'C4','sG3':'C#4','fG4':'C#4','G4':'D4','sG4':'D#4','fD0':'C#4','D0':'D4','sD0':'D#4','fD1':'D#4','D1':'E4','D2':'F4','sD2':'F#4','fD3':'F#4','D3':'G4','sD3':'G#4','fD4':'G#4','D4':'A4','sD4':'A#4','fA0':'G#4','A0':'A4','A1':'A#4','nA1':'B4','A2':'C5','sA2':'C#5','fA3':'C#5','A3':'D5','sA3':'D#5','fA4':'D#5','A4':'E5','fE0':'D#5','E0':'E5','E1':'F5','sE1':'F#5','fE2':'F#5','E2':'G5','sE2':'G#5','fE3':'G#5','E3':'A5','E4':'A#5','nE4':'B5',},'b-flat-major':{'G0':'G3','sG0':'G#3','fG1':'G#3','G1':'A3','G2':'A#3','nG2':'B3','G3':'C4','sG3':'C#4','fG4':'C#4','G4':'D4','sG4':'D#4','fD0':'C#4','D0':'D4','D1':'D#4','nD1':'E4','D2':'F4','sD2':'F#4','fD3':'F#4','D3':'G4','sD3':'G#4','fD4':'G#4','D4':'A4','sD4':'A#4','fA0':'G#4','A0':'A4','A1':'A#4','nA1':'B4','A2':'C5','sA2':'C#5','fA3':'C#5','A3':'D5','A4':'D#5','nA4':'E5','E0':'D#5','nE0':'E5','E1':'F5','sE1':'F#5','fE2':'F#5','E2':'G5','sE2':'G#5','fE3':'G#5','E3':'A5','E4':'A#5','nE4':'B5',},'e-flat-major':{'G0':'G3','G1':'G#3','nG1':'A3','G2':'A#3','nG2':'B3','G3':'C4','sG3':'C#4','fG4':'C#4','G4':'D4','sG4':'D#4','fD0':'C#4','D0':'D4','D1':'D#4','nD1':'E4','D2':'F4','sD2':'F#4','fD3':'F#4','D3':'G4','D4':'G#4','nD4':'A4','A0':'G#4','nA0':'A4','A1':'A#4','nA1':'B4','A2':'C5','sA2':'C#5','fA3':'C#5','A3':'D5','A4':'D#5','nA4':'E5','E0':'D#5','nE0':'E5','E1':'F5','sE1':'F#5','fE2':'F#5','E2':'G5','E3':'G#5','nE3':'A5','E4':'A#5','nE4':'B5',},'a-flat-major':{'G0':'G3','G1':'G#3','nG1':'A3','G2':'A#3','nG2':'B3','G3':'C4','G4':'C#4','nG4':'D4','D0':'C#4','nD0':'D4','D1':'D#4','nD1':'E4','D2':'F4','sD2':'F#4','fD3':'F#4','D3':'G4','D4':'G#4','nD4':'A4','A0':'G#4','nA0':'A4','A1':'A#4','nA1':'B4','A2':'C5','A3':'C#5','nA3':'D5','A4':'D#5','nA4':'E5','E0':'D#5','nE0':'E5','E1':'F5','sE1':'F#5','fE2':'F#5','E2':'G5','E3':'G#5','nE3':'A5','E4':'A#5','nE4':'B5',},'d-flat-major':{'G0':'F#3','nG0':'G3','G1':'G#3','nG1':'A3','G2':'A#3','nG2':'B3','G3':'C4','G4':'C#4','nG4':'D4','D0':'C#4','nD0':'D4','D1':'D#4','nD1':'E4','D2':'F4','D3':'F#4','nD3':'G4','D4':'G#4','nD4':'A4','A0':'G#4','nA0':'A4','A1':'A#4','nA1':'B4','A2':'C5','A3':'C#5','nA3':'D5','A4':'D#5','nA4':'E5','E0':'D#5','nE0':'E5','E1':'F5','E2':'F#5','nE2':'G5','E3':'G#5','nE3':'A5','E4':'A#5','nE4':'B5',},'g-flat-major':{'G0':'F#3','nG0':'G3','G1':'G#3','nG1':'A3','G2':'A#3','G3':'B3','nG3':'C4','G4':'C#4','nG4':'D4','D0':'C#4','nD0':'D4','D1':'D#4','nD1':'E4','D2':'F4','D3':'F#4','nD3':'G4','D4':'G#4','nD4':'A4','A0':'G#4','nA0':'A4','A1':'A#4','A2':'B4','nA2':'C5','A3':'C#5','nA3':'D5','A4':'D#5','nA4':'E5','E0':'D#5','nE0':'E5','E1':'F5','E2':'F#5','nE2':'G5','E3':'G#5','nE3':'A5','E4':'A#5','nE4':'B5',},'c-flat-major':{'G0':'F#3','nG0':'G3','G1':'G#3','nG1':'A3','G2':'A#3','G3':'B3','nG3':'C4','G4':'C#4','nG4':'D4','D0':'C#4','nD0':'D4','D1':'D#4','D2':'E4','nD2':'F4','D3':'F#4','nD3':'G4','D4':'G#4','nD4':'A4','A0':'G#4','nA0':'A4','A1':'A#4','A2':'B4','nA2':'C5','A3':'C#5','nA3':'D5','A4':'D#5','nA4':'E5','E0':'D#5','E1':'E5','nE1':'F5','E2':'F#5','nE2':'G5','E3':'G#5','nE3':'A5','E4':'A#5','nE4':'B5',},};var resetCanvas=function(){var ctx=document.getElementById('fingering_sheet').getContext('2d');var canvasWidth=200;var canvasHeight=300;ctx.clearRect(0,0,canvasWidth,canvasHeight);ctx.strokeStyle='black';ctx.lineWidth=2;var y={1:90,2:117,3:144,4:170,5:197,};for(var i=1;i<=5;i++){ctx.beginPath();ctx.moveTo(0,y[i]);ctx.lineTo(canvasWidth,y[i]);ctx.stroke()}}
var drawAccidental=function(y,type){var sign,x;if(type==='s'){sign="\u266F";x=60;y=y+7.5}else if(type==='f'){sign="\u266D";x=55;y=y+8.5}else if(type==='n'){sign="\u266E";x=55;y=y+9.5}else{return}
var ctx=document.getElementById('fingering_sheet').getContext('2d');ctx.lineWidth=2;ctx.font='24px Arial normal';ctx.strokeStyle='white';ctx.strokeText(sign,x,y);ctx.fillStyle='black';ctx.fillText(sign,x,y)}
var drawEllipse=function(y,fillColor){var ctx=document.getElementById('fingering_sheet').getContext('2d');ctx.lineWidth=1;ctx.strokeStyle='white';ctx.fillStyle=fillColor;ctx.beginPath();ctx.ellipse(95,y,10,15,45*Math.PI/180,0,2*Math.PI);ctx.fill();ctx.stroke()}
var drawNote=function(y,fillColor,accidentalType){if(accidentalType!=''){drawAccidental(y,accidentalType)}
drawEllipse(y,fillColor)}
var redrawStaffLines=function(lineToExclude){var ctx=document.getElementById('fingering_sheet').getContext('2d');ctx.strokeStyle='black';ctx.lineWidth=2;var x1=50;var x2=110;var x1Ellipse=84;var x2Ellipse=105;var y={1:90,2:117,3:144,4:170,5:197,};for(var i=1;i<=5;i++){if(lineToExclude!==i){ctx.beginPath();ctx.moveTo(x1,y[i]);ctx.lineTo(x2,y[i]);ctx.stroke()}
else{ctx.beginPath();ctx.moveTo(x1,y[i]);ctx.lineTo(x1Ellipse,y[i]);ctx.stroke();ctx.beginPath();ctx.moveTo(x2Ellipse,y[i]);ctx.lineTo(x2,y[i]);ctx.stroke()}}}
var drawLedgerLine=function(level,midLedgerLine){var ctx=document.getElementById('fingering_sheet').getContext('2d');ctx.strokeStyle='black';ctx.lineWidth=2;var x1Ledger=45;var x1Ellipse=84;var x2Ellipse=105;var x2Ledger=145;var y;if(level==='low1'){y=223}
else if(level==='low2'){y=249}
else if(level==='high1'){y=64}
if(midLedgerLine===0){ctx.beginPath();ctx.moveTo(x1Ledger,y);ctx.lineTo(x2Ledger,y);ctx.stroke()}
else{ctx.beginPath();ctx.moveTo(x1Ledger,y);ctx.lineTo(x1Ellipse,y);ctx.stroke();ctx.beginPath();ctx.moveTo(x2Ellipse,y);ctx.lineTo(x2Ledger,y);ctx.stroke()}}
var updateCanvas=function(notePosition,fillColor){var accidentalType=notePosition.substring(0,1).match('s|f|n')||[''];accidentalType=accidentalType[0];if(accidentalType!=''){notePosition=notePosition.substring(1)}
drawNote(notePosY[notePosition],fillColor,accidentalType);if(notePosition==='G0'){drawLedgerLine('low1',0);drawLedgerLine('low2',0)}
else if(notePosition==='G1'){drawLedgerLine('low1',0);drawLedgerLine('low2',1)}
else if(notePosition==='G2'){drawLedgerLine('low1',0);drawLedgerLine('low2',0)}
else if(notePosition==='G3'){drawLedgerLine('low1',1)}
else if(notePosition==='E3'){drawLedgerLine('high1',1)}
else if(notePosition==='E4'){drawLedgerLine('high1',0)}
var midStaffLine=0;if(notePosition==='D1'){midStaffLine=5}
else if(notePosition==='D3'){midStaffLine=4}
else if(notePosition==='A1'){midStaffLine=3}
else if(notePosition==='A3'){midStaffLine=2}
else if(notePosition==='E1'){midStaffLine=1}
redrawStaffLines(midStaffLine)}
var giveNewNote=function(){var notePosition=availableNotes[Math.floor(Math.random()*availableNotes.length)];correctNotePosition=notePosition;updateCanvas(notePosition,'black');correctNote=noteMapping[document.getElementById('key').value][notePosition]};var updateNoteBeingPlayedFingering=function(message){document.getElementById('fingering_note').innerHTML='Your Note: <b>'+message+'</b>'};var detectPitch=function(){if(redPeriod===1||greenPeriod===1){frameId=window.requestAnimationFrame(detectPitch);return}
var buffer=new Uint8Array(analyserAudioNode.fftSize);analyserAudioNode.getByteTimeDomainData(buffer);var fundalmentalFreq=findFundamentalFreq(buffer,audioContext.sampleRate);if(fundalmentalFreq!==-1){var note=findClosestNote(fundalmentalFreq,notesArray);var cents=findCentsOffPitch(fundalmentalFreq,note.frequency);if(note.note===correctNote){updateNoteBeingPlayedFingering(note.note.slice(0,-1));updateCanvas(correctNotePosition,'green');consecutiveCorrectNotes+=1;if(consecutiveCorrectNotes===3){greenPeriod=1;consecutiveCorrectNotes=0;setTimeout(function(){greenPeriod=0;resetCanvas();giveNewNote()},(0.60*1000))}}else{updateNoteBeingPlayedFingering(note.note.slice(0,-1));updateCanvas(correctNotePosition,'red');consecutiveCorrectNotes=0;setTimeout(function(){redPeriod=0},(0.10*1000))}}else{updateCanvas(correctNotePosition,'black')}
frameId=window.requestAnimationFrame(detectPitch)};var streamReceivedFingering=function(stream){streamReceived(stream);detectPitch()};var keySigChange=function(){var newKey=document.getElementById('key').value;availableNotes=Object.keys(noteMapping[newKey]);if(isMicrophoneInUse){turnOffMicrophone();window.cancelAnimationFrame(frameId);correctNotePosition='';correctNote='';consecutiveCorrectNotes=0;redPeriod=0;greenPeriod=0;updateNoteBeingPlayedFingering('?');document.getElementById('fingering_button').innerHTML='Begin!'}
resetCanvas()}
var toggleFingering=function(){toggleTool('fingering')}
var lockedIn=!1;var lockingCount=0;var noteLockedIn='';var centsLockedIn=0;var consecDevCount=0;var timesOffPitch=0;var pitchDeviationLength=0;var noteDuration=0;var ignoreInput=!0;var ignoreCount=0;var toggleSteadyBowing=function(){toggleTool('steadybowing')}
var getSteadyBowingNote=function(){if(isMicrophoneInUse){var buffer=new Uint8Array(analyserAudioNode.fftSize);analyserAudioNode.getByteTimeDomainData(buffer);var fundalmentalFreq=findFundamentalFreq(buffer,audioContext.sampleRate);if(ignoreInput){ignoreCount++;if(ignoreCount===100){ignoreCount=0;ignoreInput=!1}}else if(!lockedIn){if(fundalmentalFreq!==-1){var note=findClosestNote(fundalmentalFreq,notesArray);var cents=findCentsOffPitch(fundalmentalFreq,note.frequency);if(note.note===noteLockedIn&&cents===centsLockedIn){lockingCount++;if(lockingCount===15){lockedIn=!0;updateNoteLockedIn(note.note.slice(0,-1));updateTimesOffPitch(timesOffPitch);updateAvgDevLength(timesOffPitch,pitchDeviationLength);updateNoteDuration(noteDuration);updateNoteStatus('Hold Note')}}else{noteLockedIn=note.note;centsLockedIn=cents;lockingCount=0}}}else{noteDuration+=10;updateNoteDuration(noteDuration);if(fundalmentalFreq!==-1){var note=findClosestNote(fundalmentalFreq,notesArray);var cents=findCentsOffPitch(fundalmentalFreq,note.frequency);if(note.note===noteLockedIn&&cents>(centsLockedIn-50)&&cents<(centsLockedIn+50)){consecDevCount=0}else{consecDevCount++;if(consecDevCount===3){timesOffPitch++;updateTimesOffPitch(timesOffPitch);pitchDeviationLength+=30;updateAvgDevLength(timesOffPitch,pitchDeviationLength)}else if(consecDevCount>3){pitchDeviationLength+=10;updateAvgDevLength(timesOffPitch,pitchDeviationLength)}}}
if(noteDuration===5000){lockedIn=!1;lockingCount=0;noteLockedIn='';centsLockedIn='';consecDevCount=0;timesOffPitch=0;pitchDeviationLength=0;noteDuration=0;ignoreInput=!0;ignoreCount=0;updateNoteStatus('Release')}}
setTimeout(getSteadyBowingNote,10)}}
var streamReceivedSteadyBowing=function(stream){streamReceived(stream);getSteadyBowingNote()};var updateNoteLockedIn=function(note){document.getElementById('steadybowing_note').innerHTML='<b>'+note+'</b>'};var updateTimesOffPitch=function(timesOffPitch){if(timesOffPitch==='?'){document.getElementById('steadybowing_times_off_pitch').innerHTML='<b>?</b>'}else{var deviations=timesOffPitch.toString();document.getElementById('steadybowing_times_off_pitch').innerHTML='<b>'+deviations+'</b>'}};var updateAvgDevLength=function(timesOffPitch,pitchDeviationLength){if(timesOffPitch==='?'&&pitchDeviationLength==='?'){document.getElementById('steadybowing_avg_dur_off').innerHTML='<b>?</b>'}else if(timesOffPitch===0||pitchDeviationLength===0){document.getElementById('steadybowing_avg_dur_off').innerHTML='<b>0 ms</b>'}else{var avg=Math.round(pitchDeviationLength/timesOffPitch).toString().replace(/\B(?=(\d{3})+(?!\d))/g,',');document.getElementById('steadybowing_avg_dur_off').innerHTML='<b>'+avg+' ms</b>'}};var updateNoteDuration=function(noteDuration){if(noteDuration==='?'){document.getElementById('steadybowing_duration').innerHTML='<b>?</b>'}else{var dur=(noteDuration/1000).toString();document.getElementById('steadybowing_duration').innerHTML='<b>'+dur+' s</b>'}};var updateNoteStatus=function(message){document.getElementById('steadybowing_status').innerHTML='<b>'+message+'</b>'};var tunerNote='';var tunerCents='';var tunerConsecutiveNotes=0;var toggleTuner=function(){toggleTool('tuner')}
var getTunerNote=function(){if(isMicrophoneInUse){var buffer=new Uint8Array(analyserAudioNode.fftSize);analyserAudioNode.getByteTimeDomainData(buffer);var fundalmentalFreq=findFundamentalFreq(buffer,audioContext.sampleRate);if(fundalmentalFreq!==-1){var note=findClosestNote(fundalmentalFreq,notesArray);var cents=findCentsOffPitch(fundalmentalFreq,note.frequency);if(note.note===tunerNote&&cents===tunerCents){tunerConsecutiveNotes++;if(tunerConsecutiveNotes===3&&note.note!='F8'){updateNoteBeingPlayedTuner(note.note);updateOffPitchTuner(cents);tunerConsecutiveNotes=0}}else{tunerConsecutiveNotes=0;tunerNote=note.note;tunerCents=cents}}
setTimeout(getTunerNote,10)}}
var streamReceivedTuner=function(stream){streamReceived(stream);getTunerNote()};var updateNoteBeingPlayedTuner=function(note){document.getElementById('tuner_note').innerHTML='<b>'+note+'</b>'};var updateOffPitchTuner=function(cents){var desc='';if(cents==='?'){document.getElementById('tuner_off_pitch').innerHTML='<b>'+cents+'</b>'}else{if(+cents<0){desc='Flat'}else if(+cents>0){desc='Sharp'}else{desc='Perfect!'}
document.getElementById('tuner_off_pitch').innerHTML='<b>'+cents+'% - '+desc+'</b>'}};var metronomeActive=!1;var beatNumber=1;var prevBeatsPerMinute=100;var playBeats=function(){var beatsPerMeasure=1*document.getElementById('metronome_beats_per_measure').value;if(beatsPerMeasure===0){beatsPerMeasure=1}
if(beatNumber>beatsPerMeasure){beatNumber=1}
var beatsPerMinute=0;var tempoValStr=document.getElementById('metronome_tempo').value;var tempoValNum=+tempoValStr;if(tempoValStr.length<=1||tempoValNum<20||beatsPerMinute>300){beatsPerMinute=prevBeatsPerMinute}else{beatsPerMinute=tempoValNum;prevBeatsPerMinute=beatsPerMinute}
var timeoutMs=Math.round(60000/beatsPerMinute);if(metronomeActive){var tick=document.getElementById('metronome_tick');var tickHigh=document.getElementById('metronome_tick_high');if(beatNumber===1){tickHigh.play()}else{tick.play()}
beatNumber++;setTimeout(playBeats,timeoutMs)}}
var toggleMetronome=function(){if(metronomeActive){metronomeActive=!1;document.getElementById('metronome_button').innerHTML='Begin!'}else{metronomeActive=!0;beatNumber=1;document.getElementById('metronome_button').innerHTML='Stop!';playBeats()}}
var oscillator;var noteToFreq={'G3':196,'G3#':207.65,'A3':220,'A3#':233.08,'B3':246.94,'C4':261.63,'C4#':277.18,'D4':293.66,'D4#':311.13,'E4':329.63,'F4':349.23,'F4#':369.99,'G4':392,'G4#':415.3,'A4':440,'A4#':466.16,'B4':493.88,'C5':523.25,'C5#':554.37,'D5':587.33,'D5#':622.25,'E5':659.25,'F5':698.46,'F5#':739.99,'G5':783.99,'G5#':830.61,'A5':880,'A5#':932.33,'B5':987.77,'C6':1046.5,'C6#':1108.73,'D6':1174.66,'D6#':1244.51,'E6':1318.51,'F6':1396.91,'F6#':1479.98,'G6':1567.98,'G6#':1661.22,'A6':1760,'A6#':1864.66,'B6':1975.53,'C7':2093,'C7#':2217.46,'D7':2349.32,'D7#':2489.02,'E7':2637.02,'F7':2793.83,'F7#':2959.96,'G7':3135.96,}
var playNote=function(note){var freq=noteToFreq[note];return function(){oscillator=audioContext.createOscillator();oscillator.type='sine';oscillator.frequency.setValueAtTime(freq,audioContext.currentTime);oscillator.connect(audioContext.destination);oscillator.start()}}
var stopNote=function(){oscillator.stop()}
function userInput(e){var text='';var bypassValidation=!1;var e=e||event||window.event;var ctrlDown=e.ctrlKey||e.metaKey;if(e.type==='keypress'){var keyCode=e.keyCode||e.which;text=String.fromCharCode(keyCode);if(keyCode==8||keyCode==46||keyCode==37||keyCode==39){bypassValidation=!0}else if(ctrlDown&&(text==='c'||text==='x')){bypassValidation=!0}else if(ctrlDown&&text==='v'){text=(e.clipboardData||window.clipboardData).getData('text')}}else{text=(e.clipboardData||window.clipboardData).getData('text')}
return[text,bypassValidation]}
function onlyAllowDigits(e){var input=userInput(e);var text=input[0];var bypassValidation=input[1];if(bypassValidation){return!0}
if(/[^\d]/gi.test(text)){return!1}}
var typed=new Typed('#typed_content',{strings:['Web tools for violin^600-related...^600 endeavors^600','Web tools for violin^600ing around^600?^800','Web tools for violin^600.^800 Enjoy!',],typeSpeed:50,backSpeed:20,loop:!1,});var init=function(){var client=new XMLHttpRequest();client.onreadystatechange=function(){if(this.readyState==4&&this.status==200){freqTable=JSON.parse(client.responseText)}}
client.open('GET','/json/notes.json',!0);client.overrideMimeType('application/json');client.send();if(isAudioContextSupported()){audioContext=new window.AudioContext()}else{reportError('AudioContext is not supported in this browser')}
var panelHeaders=document.getElementsByClassName('panel_header');for(var i=0;i<panelHeaders.length;i++){panelHeaders[i].onclick=function(){var panelHeader=this;var panel=panelHeader.nextElementSibling;this.classList.toggle('active');panel.classList.toggle('active')}}
keySigChange();document.getElementById('fingering_button')['onclick']=toggleFingering;document.getElementById('key')['onclick']=keySigChange;document.getElementById('steadybowing_button')['onclick']=toggleSteadyBowing;document.getElementById('tuner_button')['onclick']=toggleTuner;document.getElementById('metronome_beats_per_measure').onkeypress=onlyAllowDigits;document.getElementById('metronome_beats_per_measure').onpaste=onlyAllowDigits;document.getElementById('metronome_tempo').onkeypress=onlyAllowDigits;document.getElementById('metronome_tempo').onpaste=onlyAllowDigits;document.getElementById('metronome_button')['onclick']=toggleMetronome;var fingerboardButtons=document.getElementsByClassName('fingerboard_button');for(var i=0;i<fingerboardButtons.length;i++){fingerboardButtons[i].onmousedown=playNote(fingerboardButtons[i].innerHTML);fingerboardButtons[i].onmouseup=stopNote;fingerboardButtons[i].onmouseout=stopNote;fingerboardButtons[i].ontouchstart=playNote(fingerboardButtons[i].innerHTML);fingerboardButtons[i].ontouchend=stopNote;fingerboardButtons[i].ontouchcancel=stopNote}};init()}
